{% extends "base.html" %}

{% block head %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/search.css') }}">
   
{% endblock %}

{% block title %}Search Employees | Employee Skills Tracker{% endblock %}

{% block content %}
<div class="search-page" style="display: flex; flex-direction: row; gap: 24px;">
    <!-- Left Filters -->
    <div class="search-sidebar" style="flex: 0 0 300px;">
        <div class="form-group">
            <label for="search_business_id"><i class="fas fa-id-card"></i> Business ID:</label>
            <div class="autocomplete-wrapper" style="position: relative;">
                <input type="text" id="search_business_id" name="business_id" value="{{ request.args.get('business_id', '') }}" class="form-input autocomplete-input" placeholder="Type business ID..." autocomplete="off" data-autocomplete-list='{{ all_employees | tojson }}' data-autocomplete-field="busness_id">
            </div>
        </div>
        <div class="form-group">
            <label for="search_name"><i class="fas fa-user"></i> Name:</label>
            <div class="autocomplete-wrapper" style="position: relative;">
                <input type="text" id="search_name" name="name" value="{{ request.args.get('name', '') }}" class="form-input autocomplete-input" placeholder="Type name..." autocomplete="off" data-autocomplete-list='{{ all_employees | tojson }}' data-autocomplete-field="full_name">
            </div>
        </div>
        <div class="form-group">
            <label for="search_department"><i class="fas fa-building"></i> Department:</label>
            <select id="search_department" name="department" class="form-input">
                <option value="">All Departments</option>
                {% for dept in departments %}
                <option value="{{ dept }}" {% if request.args.get('department') == dept %}selected{% endif %}>{{ dept }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="search_skill"><i class="fas fa-cogs"></i> Skill:</label>
            <div class="autocomplete-wrapper" style="position: relative;">
                <input type="text" id="search_skill" name="skill_name" class="form-input autocomplete-input" value="{{ request.args.get('skill_name', '') }}" placeholder="Type skill..." autocomplete="off" data-autocomplete-list='{{ existing_skills | tojson }}' data-autocomplete-field="skill_name">
            </div>
        </div>
        <div class="form-group">
            <label for="search_skill_category">Skill Category:</label>
            <select id="search_skill_category" name="skill_category" class="form-input">
                <option value="">All Categories</option>
                {% for cat in skill_categories %}
                <option value="{{ cat.category_id }}" {% if request.args.get('skill_category') == cat.category_id|string %}selected{% endif %}>{{ cat.category_name }}</option>
                {% endfor %}
            </select>
        </div>
    </div>
    <!-- Center Results -->
    <div class="search-results" style="flex: 1; min-width: 0;">
        {% if employees %}
            <h2><i class="fas fa-users"></i> Search Results</h2>
            <div class="table-container">
                <table class="results-table">
                    <thead>
                        <tr>
                            <th><i class="fas fa-id-card"></i> Business ID</th>
                            <th><i class="fas fa-user"></i> Name</th>
                            <th><i class="fas fa-building"></i> Department</th>
                            <th><i class="fas fa-cogs"></i> Technical Skills</th>
                            <th><i class="fas fa-eye"></i> Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for employee in employees %}
                        <tr>
                            <td>{{ employee.business_id }}</td>
                            <td>{{ employee.name }}</td>
                            <td>{{ employee.department }}</td>
                            <td>{{ employee.skills.Technical|join(', ') }}</td>
                            <td>
                                <a href="{{ url_for('employee_detail', employee_id=employee.id) }}" class="btn btn-view">
                                    <i class="fas fa-user-circle"></i> View
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% elif request.args %}
            <div class="no-results">
                <i class="fas fa-exclamation-circle"></i>
                <p>No employees found matching your criteria</p>
            </div>
        {% endif %}
        {% if total_pages > 1 %}
        <div class="pagination" style="display: flex; justify-content: center; gap: 8px; margin-top: 24px;">
            {% if page > 1 %}
            <a class="btn btn-secondary" href="{{ url_for('search') }}?{{ query_string }}&page={{ page-1 }}">&laquo; Prev</a>
            {% endif %}
            {% for p in range(1, total_pages+1) %}
                {% if p == page %}
                    <span class="btn btn-primary" style="pointer-events: none;">{{ p }}</span>
                {% else %}
                    <a class="btn btn-secondary" href="{{ url_for('search') }}?{{ query_string }}&page={{ p }}">{{ p }}</a>
                {% endif %}
            {% endfor %}
            {% if page < total_pages %}
            <a class="btn btn-secondary" href="{{ url_for('search') }}?{{ query_string }}&page={{ page+1 }}">Next &raquo;</a>
            {% endif %}
        </div>
        {% endif %}
    </div>
    <!-- Right Filters -->
    <form method="GET" action="/search" class="search-sidebar search-form" style="display: flex; flex-direction: column; height: 100%;">
        <div id="sidebar-filters" style="flex: 0 0 auto;">
            <div class="form-group">
                <label for="search_skill_level">Skill Level:</label>
                <select id="search_skill_level" name="skill_level" class="form-input">
                    <option value="">All Levels</option>
                    <option value="Beginner">Beginner</option>
                    <option value="Intermediate">Intermediate</option>
                    <option value="Advanced">Advanced</option>
                    <option value="Expert">Expert</option>
                    <option value="Not Applicable">Not Applicable</option>
                </select>
            </div>
            <div class="form-group">
                <label for="search_certificate_type">Certificate Type:</label>
                <select id="search_certificate_type" name="certificate_type" class="form-input">
                    <option value="">All Certificate Types</option>
                    {% for cert in certificate_types %}
                    <option value="{{ cert.cert_type_id }}" {% if request.args.get('certificate_type') == cert.cert_type_id|string %}selected{% endif %}>{{ cert.type_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="search_document_type">Document Type:</label>
                <select id="search_document_type" name="document_type" class="form-input">
                    <option value="">All Document Types</option>
                    {% for doc in document_types %}
                    <option value="{{ doc.type_id }}" {% if request.args.get('document_type') == doc.type_id|string %}selected{% endif %}>{{ doc.doc_type_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="search_supervisor">Supervisor:</label>
                <div class="autocomplete-wrapper" style="position: relative;">
                    <input type="text" id="search_supervisor" name="supervisor_name" class="form-input autocomplete-input" value="{{ request.args.get('supervisor_name', '') }}" placeholder="Type supervisor..." autocomplete="off" data-autocomplete-list='{{ all_employees | tojson }}' data-autocomplete-field="full_name">
                    <input type="hidden" id="search_supervisor_emp_id" name="supervisor_emp_id" value="{{ request.args.get('supervisor_emp_id', '') }}">
                </div>
            </div>
        </div>
        <div style="flex: 1 1 auto;"></div>
        <div class="form-actions sidebar-bottom" style="flex-direction: column; gap: 12px; margin-bottom: 0;">
            <button type="submit" class="btn btn-primary" style="width: 100%;">
                <i class="fas fa-search"></i> Search
            </button>
            <a href="{{ url_for('search') }}" class="btn btn-secondary" style="width: 100%;">
                <i class="fas fa-undo"></i> Clear
            </a>
        </div>
    </form>
</div>
<script>
// Helper to get full name for employee
function getFullName(emp) {
    if (emp.english_name && emp.busness_id) {
        return emp.english_name + ' (' + emp.busness_id + ')';
    }
    if (emp.english_name && emp.arab_name) {
        return emp.english_name + ' (' + emp.arab_name + ')';
    }
    return emp.english_name || emp.arab_name || emp.busness_id || '';
}

function setupAutocomplete(input) {
    const list = JSON.parse(input.getAttribute('data-autocomplete-list'));
    const field = input.getAttribute('data-autocomplete-field');
    let dropdown;
    input.addEventListener('input', function() {
        closeDropdown();
        const value = this.value.trim().toLowerCase();
        if (!value) return;
        dropdown = document.createElement('div');
        dropdown.className = 'autocomplete-dropdown';
        let matches = [];
        if (field === 'full_name') {
            matches = list.filter(emp => getFullName(emp).toLowerCase().includes(value)).slice(0, 8);
        } else {
            matches = list.filter(item => (item[field] || '').toLowerCase().includes(value)).slice(0, 8);
        }
        matches.forEach(item => {
            const option = document.createElement('div');
            option.className = 'autocomplete-option';
            option.textContent = field === 'full_name' ? getFullName(item) : item[field];
            option.addEventListener('mousedown', function(e) {
                input.value = this.textContent;
                closeDropdown();
            });
            dropdown.appendChild(option);
        });
        if (matches.length > 0) {
            input.parentNode.appendChild(dropdown);
        }
    });
    input.addEventListener('blur', function() {
        setTimeout(closeDropdown, 100);
    });
    function closeDropdown() {
        if (dropdown && dropdown.parentNode) {
            dropdown.parentNode.removeChild(dropdown);
            dropdown = null;
        }
    }
}
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.autocomplete-input').forEach(setupAutocomplete);
    // Skill search
    document.querySelectorAll('.skill-search').forEach(initSkillSearch);
    // Supervisor search
    document.querySelectorAll('.supervisor-search').forEach(initSupervisorSearch);
    // Department dropdown UX
    const deptSelect = document.getElementById('search_department');
    deptSelect.addEventListener('focus', function() {
        const visibleOptions = Math.min(this.options.length, 5);
        const optionHeight = 38;
        this.size = visibleOptions;
        this.style.height = `${visibleOptions * optionHeight}px`;
    });
    deptSelect.addEventListener('blur', function() {
        this.size = 1;
        this.style.height = '';
    });
    deptSelect.addEventListener('change', function() {
        this.size = 1;
        this.style.height = '';
        this.blur();
    });
    // Add existing skills data to JavaScript
    window.existingSkills = {{ existing_skills|tojson|safe }};
});
</script>
<style>
/* Make dropdown text black in all sidebars */
.search-sidebar select, .search-sidebar option, .search-sidebar input, .search-sidebar .form-input {
    color: #222 !important;
    background: #fff !important;
}
.search-sidebar .form-input::placeholder {
    color: #888 !important;
}
</style>
{% endblock %}