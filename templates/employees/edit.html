{% extends "base.html" %}

{% block title %}Edit Employee | Employee Skills Tracker{% endblock %}

{% block head %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/employee_form.css') }}">
{% endblock %}

{% block content %}
<div class="form-container">
    <h1><i class="fas fa-user-edit"></i> Edit Employee</h1>

    {% include '_flash_messages.html' %}

    <form method="POST" enctype="multipart/form-data" action="{{ url_for('edit_employee', employee_id=employee.emp_id) }}" id="employee-form">
        <!-- Basic Information -->
        <div class="form-section">
            <h2><i class="fas fa-id-card"></i> Basic Information</h2>
            
            <div class="form-group">
                <label>Business ID</label>
                <div class="form-control-readonly">{{ employee.busness_id }}</div>
                <input type="hidden" name="busness_id" value="{{ employee.busness_id }}">
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="english_name">English Name*</label>
                    <input type="text" id="english_name" name="english_name" 
                           value="{{ employee.english_name }}" required>
                </div>
                <div class="form-group">
                    <label for="arab_name">Arabic Name*</label>
                    <input type="text" id="arab_name" name="arab_name" 
                           value="{{ employee.arab_name }}" required>
                </div>
            </div>

            <!-- Department Dropdown -->
            <div class="form-group">
                <label for="department_id">Department*</label>
                <select id="department_id" name="department_id" required>
                    {% if departments %}
                        {% for department in departments %}
                        <option value="{{ department.department_id }}"
                            {% if employee.department_id == department.department_id %}selected{% endif %}>
                            {{ department.department_name }}
                        </option>
                        {% endfor %}
                    {% else %}
                        <option value="">No departments available</option>
                    {% endif %}
                </select>
            </div>

            <!-- Position Dropdown -->
            <div class="form-group">
                <label for="position_id">Position*</label>
                <select id="position_id" name="position_id" required>
                    <option value="">Select Position</option>
                    {% if positions %}
                        {% for position in positions %}
                        <option value="{{ position.position_id }}"
                            {% if employee.position_id == position.position_id %}selected{% endif %}>
                            {{ position.position_name }}
                        </option>
                        {% endfor %}
                    {% else %}
                        <option value="">No positions available</option>
                    {% endif %}
                </select>
            </div>

            <!-- Level Dropdown -->
            <div class="form-group">
                <label for="level_id">Level*</label>
                <select id="level_id" name="level_id" required>
                    <option value="">Select Level</option>
                    {% if levels %}
                        {% for level in levels %}
                        <option value="{{ level.level_id }}"
                            {% if employee.level_id == level.level_id %}selected{% endif %}>
                            {{ level.level_name }}
                        </option>
                        {% endfor %}
                    {% else %}
                        <option value="">No levels available</option>
                    {% endif %}
                </select>
            </div>

            <!-- Status Toggle -->
            <div class="form-group">
                <label class="checkbox-container">
                    <input type="hidden" name="is_active" value="false">
                    <input type="checkbox" name="is_active" value="true" 
                           {% if employee.is_active %}checked{% endif %}
                           onchange="this.previousElementSibling.value=this.checked ? 'true' : 'false'">
                    <span class="checkmark"></span>
                    Active Employee
                </label>
            </div>
        </div>

        <div class="form-section">
            <h4>Skills</h4>
            <div id="skills-section">
              {% for skill in employee_skills %}
                <div class="skill-entry mb-4 p-3 border rounded">
                  <input type="text" name="skill_name[]" value="{{ skill.name }}" class="form-control mb-2" placeholder="Skill name" />
          
                  <select name="skill_category[]" class="form-select mb-2">
                    <option value="">Select category</option>
                    {% for category in skill_categories %}
                      <option value="{{ category.category_id }}"
                        {% if category.category_name == skill.category %}selected{% endif %}>
                        {{ category.category_name }}
                      </option>
                    {% endfor %}
                  </select>
          
                  <select name="skill_level[]" class="form-select mb-2">
                    <option value="">Select level</option>
                    {% for level in ['Beginner', 'Intermediate', 'Advanced'] %}
                      <option value="{{ level }}"
                        {% if level == skill.level %}selected{% endif %}>
                        {{ level }}
                      </option>
                    {% endfor %}
                  </select>
          
                  <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" name="skill_certified[]" value="{{ loop.index0 }}"
                      {% if skill.certified %}checked{% endif %} onchange="toggleCertification(this)">
                    <label class="form-check-label">Certified</label>
                  </div>
          
                  <div class="certification-details" style="display: '{{ 'block' if skill.certified else 'none' }}';">
                    <select name="certificate_type_id[]" class="form-select mb-2">
                      <option value="">Certificate type</option>
                      {% for cert in certificate_types %}
                        <option value="{{ cert.cert_type_id }}">{{ cert.type_name }}</option>
                      {% endfor %}
                    </select>
          
                    <input type="text" name="issuing_organization[]" class="form-control mb-2" placeholder="Issuing organization">
                    <input type="number" name="validity_period_months[]" class="form-control mb-2" placeholder="Validity (months)" min="0">
          
                    <div class="document-group mb-2">
                      <input type="file" name="document_file_{{ loop.index0 }}[]" class="form-control">
                    </div>
          
                    <button type="button" onclick="addDocumentField(this)" class="btn btn-sm btn-outline-secondary">
                      <i class="fas fa-plus"></i> Add Document
                    </button>
                  </div>
                </div>
              {% endfor %}
            </div>
          
            <button type="button" onclick="addSkillField()" class="btn btn-secondary">
              <i class="fas fa-plus"></i> Add Another Skill
            </button>
          </div>
          
          <!-- General Documents -->
          <div class="form-section mt-5">
            <h4><i class="fas fa-folder-open"></i> General Documents</h4>
            <div id="general-documents">
              <div class="document-row mb-3">
                <select name="general_document_type_id[]" class="form-select mb-2">
                  <option value="">Document type</option>
                  {% for doc in document_types %}
                    <option value="{{ doc.type_id }}">{{ doc.doc_type_name }}</option>
                  {% endfor %}
                </select>
          
                <input type="file" name="general_document_file[]" class="form-control mb-2">
          
                <button type="button" onclick="this.parentNode.remove()" class="btn btn-danger btn-sm">
                  <i class="fas fa-trash"></i> Remove
                </button>
              </div>
            </div>
          
            <button type="button" onclick="addGeneralDocument()" class="btn btn-secondary">
              <i class="fas fa-plus"></i> Add Document
            </button>
          </div>
          <div class="form-actions">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> Save Employee
            </button>
            <a href="{{ url_for('list_employees') }}" class="btn btn-secondary">
                <i class="fas fa-times"></i> Cancel
            </a>
        </div>
          <script>
            let skillIndex = parseInt("{{ (employee_skills|length if employee_skills is defined else 0)|int }}", 10);
            function addSkillField() {
              const container = document.getElementById('skills-section');
              const newRow = document.createElement('div');
              newRow.className = 'skill-entry mb-4 p-3 border rounded';
              newRow.innerHTML = `
                <input type="text" name="skill_name[]" class="form-control mb-2" placeholder="Skill name" />
            
                <select name="skill_category[]" class="form-select mb-2">
                  <option value="">Select category</option>
                  {% for category in skill_categories %}
                    <option value="{{ category.category_id }}">{{ category.category_name }}</option>
                  {% endfor %}
                </select>
            
                <select name="skill_level[]" class="form-select mb-2">
                  <option value="">Select level</option>
                  {% for level in ['Beginner', 'Intermediate', 'Advanced'] %}
                    <option value="{{ level }}">{{ level }}</option>
                  {% endfor %}
                </select>
            
                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" name="skill_certified[]" value="${skillIndex}" onchange="toggleCertification(this)">
                  <label class="form-check-label">Certified</label>
                </div>
            
                <div class="certification-details" style="display: none;">
                  <select name="certificate_type_id[]" class="form-select mb-2">
                    <option value="">Certificate type</option>
                    {% for cert in certificate_types %}
                      <option value="{{ cert.cert_type_id }}">{{ cert.type_name }}</option>
                    {% endfor %}
                  </select>
            
                  <input type="text" name="issuing_organization[]" class="form-control mb-2" placeholder="Issuing organization">
                  <input type="number" name="validity_period_months[]" class="form-control mb-2" placeholder="Validity (months)" min="0">
            
                  <div class="document-group mb-2">
                    <input type="file" name="document_file_${skillIndex}[]">
                  </div>
            
                  <button type="button" onclick="addDocumentField(this)" class="btn btn-sm btn-outline-secondary">
                    <i class="fas fa-plus"></i> Add Document
                  </button>
                </div>
            
                <button type="button" onclick="this.parentNode.remove()" class="btn btn-danger btn-sm mt-2">
                  <i class="fas fa-trash"></i> Remove
                </button>
              `;
              container.appendChild(newRow);
              skillIndex++;
            }
            
            function toggleCertification(checkbox) {
              const certSection = checkbox.closest('.skill-entry').querySelector('.certification-details');
              certSection.style.display = checkbox.checked ? 'block' : 'none';
            }
            
            function addDocumentField(button) {
              const group = button.closest('.certification-details').querySelector('.document-group');
              const input = document.createElement('input');
              input.type = 'file';
              input.name = group.querySelector('input').name;
              input.className = 'form-control mt-2';
              group.appendChild(input);
            }
            
            function addGeneralDocument() {
              const container = document.getElementById('general-documents');
              const row = document.createElement('div');
              row.className = 'document-row mb-3';
              row.innerHTML = `
                <select name="general_document_type_id[]" class="form-select mb-2">
                  <option value="">Document type</option>
                  {% for doc in document_types %}
                    <option value="{{ doc.type_id }}">{{ doc.type_name }}</option>
                  {% endfor %}
                </select>
            
                <input type="file" name="general_document_file[]" class="form-control mb-2">
            
                <button type="button" onclick="this.parentNode.remove()" class="btn btn-danger btn-sm">
                  <i class="fas fa-trash"></i> Remove
                </button>
              `;
              container.appendChild(row);
            }
            </script>
            {% endblock %}