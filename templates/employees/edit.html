{% extends "base.html" %}

{% block title %}Edit Employee | Employee Skills Tracker{% endblock %}

{% block head %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/employee_form.css') }}">
    <style>
        /* Consistent Table Styling */
        .data-table-wrapper { width: 100%; margin-top: 8px; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 1em; background: #fff; box-shadow: 0 2px 8px rgba(60,60,120,0.06); border-radius: 8px; overflow: hidden; }
        .data-table th, .data-table td { padding: 12px 16px; text-align: center; border-bottom: 1px solid #e0e0e0; }
        .data-table th { background: #f6f7fa; color: #217a3a; font-weight: 700; }
        .data-table tr:last-child td { border-bottom: none; }
        
        /* Skills Specific */
        .certified-dot { display: inline-block; width: 18px; height: 18px; border-radius: 50%; }
        .certified-dot.green { background: #38d39f; border: 2px solid #38d39f; }
        .certified-dot.red { background: #e57373; border: 2px solid #e57373; }
        .skill-type-header td { border-top: 2px solid #e0e0e0; background: #f6f7fa !important; color: #217a3a; font-weight: 700; font-size: 1.05em; }
        
        /* Form Elements */
        .form-control-sm { padding: 0.25rem 0.5rem; font-size: 0.875rem; }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.875rem; }
        .btn i { margin-right: 5px; }
        
        /* Action Buttons */
        .action-buttons { white-space: nowrap; }
        .action-buttons .btn { margin: 0 3px; }
        
        /* Certificate Details */
        .cert-details-cell { text-align: left !important; padding: 8px !important; }
        .cert-details-content { background: #f8f9fc; border-radius: 6px; padding: 12px; }
        
        /* Document Type Badges */
        .document-type-badge { 
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            background: #f0f7ff;
            color: #4e73df;
            font-size: 0.85rem;
        }
        
        /* Form Sections */
        .form-section { 
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 2rem;
            margin-bottom: 2rem;
        }
    </style>
{% endblock %}

{% block content %}
<div class="form-container">
    <h1><i class="fas fa-user-edit"></i> Edit Employee</h1>

    {% include '_flash_messages.html' %}

    <form method="POST" enctype="multipart/form-data" action="{{ url_for('edit_employee', employee_id=employee.emp_id) }}" id="employee-form">
        <!-- Basic Information Section -->
        <div class="form-section">
            <h2><i class="fas fa-id-card"></i> Basic Information</h2>
            
            <div class="form-group">
                <label>Business ID</label>
                <div class="form-control-readonly">{{ employee.busness_id }}</div>
                <input type="hidden" name="busness_id" value="{{ employee.busness_id }}">
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="english_name">English Name*</label>
                    <input type="text" id="english_name" name="english_name" 
                           value="{{ employee.english_name }}" required>
                </div>
                <div class="form-group">
                    <label for="arab_name">Arabic Name*</label>
                    <input type="text" id="arab_name" name="arab_name" 
                           value="{{ employee.arab_name }}" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="email">Email*</label>
                    <input type="email" id="email" name="email" 
                           value="{{ employee.email }}" required>
                </div>
                <div class="form-group">
                    <label for="phone">Phone</label>
                    <input type="tel" id="phone" name="phone" 
                           value="{{ employee.phone or '' }}">
                </div>
            </div>

            <div class="form-group">
                <label for="hire_date">Hire Date*</label>
                <input type="date" id="hire_date" name="hire_date" 
                       value="{{ employee.hire_date.strftime('%Y-%m-%d') }}" required>
            </div>

            <!-- Department Dropdown -->
            <div class="form-group">
                <label for="department_id">Department*</label>
                <select id="department_id" name="department_id" required>
                    {% if departments %}
                        {% for department in departments %}
                        <option value="{{ department.department_id }}"
                            {% if employee.department_id == department.department_id %}selected{% endif %}>
                            {{ department.department_name }}
                        </option>
                        {% endfor %}
                    {% else %}
                        <option value="">No departments available</option>
                    {% endif %}
                </select>
            </div>

            <!-- Position Dropdown -->
            <div class="form-group">
                <label for="position_id">Position*</label>
                <select id="position_id" name="position_id" required>
                    <option value="">Select Position</option>
                    {% if positions %}
                        {% for position in positions %}
                        <option value="{{ position.position_id }}"
                            {% if employee.position_id == position.position_id %}selected{% endif %}>
                            {{ position.position_name }}
                        </option>
                        {% endfor %}
                    {% else %}
                        <option value="">No positions available</option>
                    {% endif %}
                </select>
            </div>

            <!-- Level Dropdown -->
            <div class="form-group">
                <label for="level_id">Level*</label>
                <select id="level_id" name="level_id" required>
                    <option value="">Select Level</option>
                    {% if levels %}
                        {% for level in levels %}
                        <option value="{{ level.level_id }}"
                            {% if employee.level_id == level.level_id %}selected{% endif %}>
                            {{ level.level_name }}
                        </option>
                        {% endfor %}
                    {% else %}
                        <option value="">No levels available</option>
                    {% endif %}
                </select>
            </div>

            <!-- Status Toggle -->
            <div class="form-group">
                <label class="checkbox-container">
                    <!-- hidden ensures unchecked still submits -->
                    <input type="hidden" name="is_active" value="false">
                    
                    <input type="checkbox" name="is_active" value="true" 
                           {% if employee.is_active %}checked{% endif %}>
                    <span class="checkmark"></span>
                    Active Employee
                </label>
            </div>
            
        </div>


        <!-- Skills Section -->
        <div class="form-section">
            <h3><i class="fas fa-cogs"></i> Skills</h3>
            <div class="data-table-wrapper">
                <table class="data-table" id="skills-table">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Skill</th>
                            <th>Level</th>
                            <th>Certified</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if employee_skills %}
                            {% set grouped_skills = {} %}
                            {% for skill_name, category_name, skill_level, certified in employee_skills %}
                                {% set _ = grouped_skills.setdefault(category_name or 'Uncategorized', []).append({
                                    'name': skill_name, 
                                    'level': skill_level, 
                                    'certified': certified,
                                    'cert_details': (employee_documents | selectattr('skill_name', 'equalto', skill_name) | list | first) if certified else None
                                }) %}
                            {% endfor %}
                            
                            {% for type, skill_list in grouped_skills.items() %}
                                {% for skill in skill_list %}
                                <tr class="skill-row" data-skill-name="{{ skill.name }}">
                                    {% if loop.first %}
                                    <td rowspan="{{ skill_list|length }}" style="font-weight:700; color:#217a3a; background:#f6f7fa; vertical-align:middle;">
                                        <select name="skill_category[]" class="form-control form-control-sm">
                                            <option value="">Select category</option>
                                            {% for category in skill_categories %}
                                                <option value="{{ category.category_id }}" {% if type == category.category_name %}selected{% endif %}>{{ category.category_name }}</option>
                                            {% endfor %}
                                        </select>
                                    </td>
                                    {% endif %}
                                    <td>
                                        <input type="text" name="skill_name[]" class="form-control form-control-sm" value="{{ skill.name }}">
                                    </td>
                                    <td>
                                        <select name="skill_level[]" class="form-control form-control-sm">
                                            <option value="">Select level</option>
                                            {% for level in ['Beginner', 'Intermediate', 'Advanced'] %}
                                                <option value="{{ level }}" {% if skill.level == level %}selected{% endif %}>{{ level }}</option>
                                            {% endfor %}
                                        </select>
                                    </td>
                                    <td>
                                        <div class="custom-control custom-switch">
                                            <input type="checkbox" class="custom-control-input" name="skill_certified[]" id="certified-{{ loop.index }}" 
                                                   {% if skill.certified %}checked{% endif %} onchange="toggleCertification(this)">
                                            <label class="custom-control-label" for="certified-{{ loop.index }}"></label>
                                        </div>
                                    </td>
                                    <td class="action-buttons">
                                        <button type="button" class="btn btn-danger btn-sm" onclick="removeSkillRow(this)">
                                            <i class="fas fa-trash-alt"></i> Remove
                                        </button>
                                    </td>
                                </tr>
                                {% if skill.certified and skill.cert_details %}
                                <tr class="cert-details-row">
                                    <td colspan="5" class="cert-details-cell">
                                        <div class="cert-details-content">
                                            <h6><i class="fas fa-certificate"></i> Certificate Details</h6>
                                            <div class="form-row">
                                                <div class="form-group col-md-4">
                                                    <label>Certificate Type</label>
                                                    <select name="certificate_type_id[]" class="form-control form-control-sm">
                                                        <option value="">Select type</option>
                                                        {% for cert in certificate_types %}
                                                            <option value="{{ cert.cert_type_id }}"
                                                                {% if skill.cert_details.cert_type_id == cert.cert_type_id %}selected{% endif %}
                                                                data-default-org="{{ cert.default_issuing_org|default('', true) }}"
                                                                data-default-validity="{{ cert.default_validity_months|default('', true) }}">
                                                                {{ cert.type_name }}
                                                            </option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                                <div class="form-group col-md-4">
                                                    <label>Issuing Organization</label>
                                                    <input type="text" name="issuing_organization[]" class="form-control form-control-sm" 
                                                           value="{{ skill.cert_details.issuing_organization if skill.cert_details.issuing_organization else '' }}">
                                                </div>
                                                <div class="form-group col-md-3">
                                                    <label>Validity (months)</label>
                                                    <input type="number" name="validity_period_months[]" class="form-control form-control-sm" 
                                                           value="{{ skill.cert_details.validity_period_months if skill.cert_details.validity_period_months else '' }}">
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label>Certificate File</label>
                                                <div class="custom-file">
                                                    <input type="file" name="document_file[]" class="custom-file-input">

                                                    <label class="custom-file-label">
                                                        {% if skill.cert_details.document_name %}
                                                            Current: {{ skill.cert_details.document_name }}
                                                        {% else %}
                                                            Choose new file
                                                        {% endif %}
                                                    </label>
                                                </div>
                                                {% if skill.cert_details.document_name %}
                                                <div class="mt-2">
                                                    <a href="{{ url_for('download_document', doc_id=skill.cert_details.document_id) }}" class="btn btn-sm btn-outline-primary">
                                                        <i class="fas fa-download"></i> Download
                                                    </a>
                                                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="confirmDeleteDocument('{{ url_for('delete_document', doc_id=skill.cert_details.document_id) }}')">
                                                        <i class="fas fa-trash"></i> Delete
                                                    </button>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endif %}
                                {% endfor %}
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="5" style="text-align:center; color:#888;">No skills recorded for this employee.</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
            
            <!-- Add New Skill Form -->
            <div class="mt-4 p-3 border rounded bg-light">
                <h5><i class="fas fa-plus-circle"></i> Add New Skill</h5>
                <div class="form-row">
                    <div class="form-group col-md-3">
                        <label for="new-skill-name">Skill Name*</label>
                        <input type="text" id="new-skill-name" class="form-control form-control-sm" list="skill-options" placeholder="e.g. Python Programming">
                        <datalist id="skill-options">
                            {% for skill in skills %}
                                <option value="{{ skill.skill_name }}"></option>
                            {% endfor %}
                        </datalist>
                    </div>
                    <div class="form-group col-md-3">
                        <label>Category</label>
                        <select id="new-skill-category" class="form-control form-control-sm">
                            <option value="">Select category</option>
                            {% for category in skill_categories %}
                                <option value="{{ category.category_id }}">{{ category.category_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group col-md-2">
                        <label>Level</label>
                        <select id="new-skill-level" class="form-control form-control-sm">
                            <option value="">Select level</option>
                            {% for level in ['Beginner', 'Intermediate', 'Advanced'] %}
                                <option value="{{ level }}">{{ level }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group col-md-2">
                        <label>Certified</label>
                        <div class="custom-control custom-switch mt-2">
                            <input type="checkbox" class="custom-control-input" id="new-skill-certified">
                            <label class="custom-control-label" for="new-skill-certified"></label>
                        </div>
                    </div>
                    <div class="form-group col-md-2 d-flex align-items-end">
                        <button type="button" class="btn btn-primary btn-sm" onclick="addNewSkill()">
                            <i class="fas fa-plus"></i> Add Skill
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Documents Section -->
        <div class="form-section">
            <h3><i class="fas fa-file-alt"></i> Documents</h3>
            <div class="data-table-wrapper">
                <table class="data-table" id="documents-table">
                    <thead>
                        <tr>
                            <th>Document Name</th>
                            <th>Type</th>
                            <th>Upload Date</th>
                            <th>Related To</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set docs = employee_documents if employee_documents is defined and employee_documents else employee.documents %}
                        {% if docs %}
                            {% for doc in docs %}
                            <tr>
                                <td>
                                    <strong>{{ doc.document_name or 'Unnamed Document' }}</strong>
                                    {% if doc.skill_name %}
                                    <div class="text-muted small">Skill: {{ doc.skill_name }}</div>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="document-type-badge">
                                        {{ doc.document_type.doc_type_name if doc.document_type else 'Unknown' }}
                                    </span>
                                </td>
                                <td>
                                    {{ doc.upload_date.strftime('%Y-%m-%d') if doc.upload_date else 'Unknown' }}
                                </td>
                                <td>
                                    {% if doc.skill_name %}
                                    <span class="badge badge-info">Skill: {{ doc.skill_name }}</span>
                                    {% else %}
                                    <span class="badge badge-secondary">General</span>
                                    {% endif %}
                                </td>
                                <td class="action-buttons">
                                    <a href="{{ url_for('download_document', doc_id=doc.document_id) }}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-download"></i> Download
                                    </a>
                                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="confirmDeleteDocument('{{ url_for('delete_document', doc_id=doc.document_id) }}')">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            
                                <tr class="no-docs-row">
                                    <td colspan="5" class="text-center">No documents uploaded.</td>
                                </tr>
                                
                            
                        {% endif %}
                    </tbody>
                </table>
            </div>
            
            <!-- Add New Document Form -->
            <div class="mt-4 p-3 border rounded bg-light">
                <h5><i class="fas fa-plus-circle"></i> Add New Document</h5>
                <div id="new-documents-container">
                    <div class="document-row form-row">
                        <div class="form-group col-md-4">
                            <label>Document Type*</label>
                            <select name="general_document_type_id[]" class="form-control form-control-sm" >
                                <option value="">Select type</option>
                                {% for doc in document_types %}
                                    <option value="{{ doc.type_id }}">{{ doc.doc_type_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group col-md-6">
                            <label>Document File*</label>
                            <div class="custom-file">
                                <input type="file" name="general_document_file[]" class="custom-file-input" >
                                <label class="custom-file-label">Choose file</label>
                            </div>
                        </div>
                        <div class="form-group col-md-2 d-flex align-items-end">
                            <button type="button" class="btn btn-danger btn-sm" onclick="removeDocumentRow(this)">
                                <i class="fas fa-trash"></i> Remove
                            </button>
                        </div>
                    </div>
                </div>
                <div class="form-group col-md-2 d-flex align-items-end">
                    <button type="button" class="btn btn-primary btn-sm" onclick="addNewDocument()">
                        <i class="fas fa-plus"></i> Add Document
                    </button>
                </div>
                
            </div>
        </div>

        <div class="form-actions mt-4">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> Save Changes
            </button>
            <a href="{{ url_for('list_employees') }}" class="btn btn-outline-secondary">
                <i class="fas fa-times"></i> Cancel
            </a>
        </div>
    </form>
</div>

<script>
    // ====================== SKILL FUNCTIONS ======================
    function addNewSkill() {
        // Get input values
        const skillName = document.getElementById('new-skill-name').value.trim();
        const categorySelect = document.getElementById('new-skill-category');
        const categoryId = categorySelect.value;
        const categoryName = categorySelect.options[categorySelect.selectedIndex].text;
        const level = document.getElementById('new-skill-level').value;
        const isCertified = document.getElementById('new-skill-certified').checked;

        // Validate
        if (!skillName || !categoryId || !level) {
            alert("Please fill in all skill fields");
            return;
        }

        // Create the new row
        const newRow = document.createElement('tr');
        newRow.className = 'skill-row';

        // Generate category options HTML
        let categoryOptions = '<option value="">Select category</option>';
        const allCategories = document.getElementById('new-skill-category').options;
        for (let i = 0; i < allCategories.length; i++) {
            const option = allCategories[i];
            if (option.value) {
                categoryOptions += `<option value="${option.value}" ${option.value === categoryId ? 'selected' : ''}>${option.text}</option>`;
            }
        }

        // Create row HTML with preselected category
        newRow.innerHTML = `
            <td>
                <select name="skill_category[]" class="form-control form-control-sm">
                    ${categoryOptions}
                </select>
            </td>
            <td>
                <input type="text" name="skill_name[]" class="form-control form-control-sm" value="${skillName}">
            </td>
            <td>
                <select name="skill_level[]" class="form-control form-control-sm">
                    <option value="">Select level</option>
                    <option value="Beginner" ${level === 'Beginner' ? 'selected' : ''}>Beginner</option>
                    <option value="Intermediate" ${level === 'Intermediate' ? 'selected' : ''}>Intermediate</option>
                    <option value="Advanced" ${level === 'Advanced' ? 'selected' : ''}>Advanced</option>
                </select>
            </td>
            <td>
                <div class="custom-control custom-switch">
                    <input type="checkbox" class="custom-control-input" name="certified[]" 
                           ${isCertified ? 'checked' : ''} onchange="toggleCertification(this)">
                    <label class="custom-control-label"></label>
                </div>
            </td>
            <td class="action-buttons">
                <button type="button" class="btn btn-danger btn-sm" onclick="removeSkillRow(this)">
                    <i class="fas fa-trash-alt"></i> Remove
                </button>
            </td>
        `;

        // Add to table
        const tbody = document.querySelector('#skills-table tbody');

        // Remove "no skills" message if present
        const noSkillsRow = tbody.querySelector('tr td[colspan="5"]');
        if (noSkillsRow) noSkillsRow.closest('tr').remove();

        tbody.appendChild(newRow);

        // Handle certification if needed
        if (isCertified) {
            toggleCertification(newRow.querySelector('input[type="checkbox"]'));
        }

        // Clear form
        document.getElementById('new-skill-name').value = '';
        document.getElementById('new-skill-category').selectedIndex = 0;
        document.getElementById('new-skill-level').selectedIndex = 0;
        document.getElementById('new-skill-certified').checked = false;
    }

    function removeSkillRow(button) {
        const row = button.closest('tr');
        const categoryCell = row.querySelector('td[style*="font-weight:700"]');

        if (categoryCell) {
            const rowspan = parseInt(categoryCell.getAttribute('rowspan')) || 1;
            if (rowspan > 1) {
                const nextRow = row.nextElementSibling;
                if (nextRow && !nextRow.classList.contains('cert-details-row')) {
                    nextRow.insertBefore(categoryCell, nextRow.firstChild);
                    categoryCell.rowSpan = rowspan - 1;
                }
            }
        } else {
            let prevRow = row.previousElementSibling;
            while (prevRow) {
                const catCell = prevRow.querySelector('td[style*="font-weight:700"]');
                if (catCell) {
                    catCell.rowSpan = (parseInt(catCell.getAttribute('rowspan')) || 1) - 1;
                    break;
                }
                prevRow = prevRow.previousElementSibling;
            }
        }

        const nextRow = row.nextElementSibling;
        if (nextRow && nextRow.classList.contains('cert-details-row')) {
            nextRow.remove();
        }

        row.remove();

        if (document.querySelectorAll('#skills-table tbody tr').length === 0) {
            document.querySelector('#skills-table tbody').innerHTML = `
                <tr>
                    <td colspan="5" style="text-align:center; color:#888;">No skills recorded for this employee.</td>
                </tr>
            `;
        }
    }

    function toggleCertification(checkbox) {
        const row = checkbox.closest('tr');
        const nextRow = row.nextElementSibling;

        if (checkbox.checked && (!nextRow || !nextRow.classList.contains('cert-details-row'))) {
            const certTypesOptions = Array.from(document.querySelector('[name="certificate_type_id[]"]').options)
                .map(option => `<option value="${option.value}" data-default-org="${option.dataset.defaultOrg || ''}" data-default-validity="${option.dataset.defaultValidity || ''}">${option.text}</option>`)
                .join('');

            const certRow = document.createElement('tr');
            certRow.className = 'cert-details-row';
            certRow.innerHTML = `
                <td colspan="5" class="cert-details-cell">
                    <div class="cert-details-content">
                        <h6><i class="fas fa-certificate"></i> Certificate Details</h6>
                        <div class="form-row">
                            <div class="form-group col-md-4">
                                <label>Certificate Type</label>
                                <select name="certificate_type_id[]" class="form-control form-control-sm">
                                    <option value="">Select type</option>
                                    ${certTypesOptions}
                                </select>
                            </div>
                            <div class="form-group col-md-4">
                                <label>Issuing Organization</label>
                                <input type="text" name="issuing_organization[]" class="form-control form-control-sm">
                            </div>
                            <div class="form-group col-md-3">
                                <label>Validity (months)</label>
                                <input type="number" name="validity_period_months[]" class="form-control form-control-sm">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Certificate File</label>
                            <div class="custom-file">
                                <input type="file" name="document_file_new_${Date.now()}" class="custom-file-input">
                                <label class="custom-file-label">Choose file</label>
                            </div>
                        </div>
                    </div>
                </td>
            `;
            row.after(certRow);
        } else if (!checkbox.checked && nextRow && nextRow.classList.contains('cert-details-row')) {
            nextRow.remove();
        }
    }

    function initFileInput(input) {
        input.addEventListener('change', function(e) {
            const fileName = e.target.files[0] ? e.target.files[0].name : "Choose file";
            e.target.nextElementSibling.textContent = fileName;
        });
    }

    function confirmDeleteDocument(deleteUrl) {
        if (confirm('Are you sure you want to delete this document?')) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = deleteUrl;
            document.body.appendChild(form);
            form.submit();
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.custom-file-input').forEach(initFileInput);

        const docSection = document.querySelector('.form-section:nth-child(3) .bg-light');
        if (docSection && !docSection.querySelector('.documents-container')) {
            const container = document.createElement('div');
            container.className = 'documents-container';
            docSection.insertBefore(container, docSection.querySelector('.form-row:last-child'));
        }
    });

    function addNewDocument() {
    const typeSelect = document.querySelector('#new-documents-container select[name="general_document_type_id[]"]');
    const fileInput = document.querySelector('#new-documents-container input[name="general_document_file[]"]');

    const docTypeId = typeSelect.value;
    const docTypeText = typeSelect.options[typeSelect.selectedIndex].text;
    const file = fileInput.files[0];

    if (!docTypeId || !file) {
        alert("Please select a document type and choose a file.");
        return;
    }

    const tbody = document.querySelector('#documents-table tbody');

    // Remove "No documents uploaded." row if it exists
    const noDocsRow = tbody.querySelector('.no-docs-row');
    if (noDocsRow) {
        noDocsRow.remove();
    }

    // Create row in the table
    const newRow = document.createElement('tr');
    newRow.innerHTML = `
        <td><strong>${file.name}</strong></td>
        <td><span class="document-type-badge">${docTypeText}</span></td>
        <td>${new Date().toISOString().split('T')[0]}</td>
        <td><span class="badge badge-secondary">General</span></td>
        <td class="action-buttons">
            <button type="button" class="btn btn-danger btn-sm" onclick="removeDocumentRow(this)">
                <i class="fas fa-trash-alt"></i> Remove
            </button>
        </td>
    `;
    tbody.appendChild(newRow);

    // Attach type to form as hidden; move the actual file input into a hidden form container (keeps the selected File)
    const form = document.querySelector('#employee-form');
    const hiddenType = document.createElement('input');
    hiddenType.type = 'hidden';
    hiddenType.name = 'general_document_type_id[]';
    hiddenType.value = docTypeId;
    form.appendChild(hiddenType);

    let hiddenBin = document.getElementById('hidden-doc-inputs');
    if (!hiddenBin) {
        hiddenBin = document.createElement('div');
        hiddenBin.id = 'hidden-doc-inputs';
        hiddenBin.style.display = 'none';
        form.appendChild(hiddenBin);
    }
    // Move the input node itself so the File is submitted
    hiddenBin.appendChild(fileInput);

    // Create a fresh visible input for the user to add another document
    const freshInput = document.createElement('input');
    freshInput.type = 'file';
    freshInput.name = 'general_document_file[]';
    freshInput.className = 'custom-file-input';
    // Replace the old input in the UI
    const customFileDiv = document.querySelector('#new-documents-container .custom-file');
    if (customFileDiv) {
        customFileDiv.innerHTML = '';
        customFileDiv.appendChild(freshInput);
        const freshLabel = document.createElement('label');
        freshLabel.className = 'custom-file-label';
        freshLabel.textContent = 'Choose file';
        customFileDiv.appendChild(freshLabel);
        initFileInput(freshInput);
    }

    // Reset the type selector for next input
    typeSelect.selectedIndex = 0;
}


    // ====================== FORM SUBMISSION INDEXING ======================
    document.getElementById('employee-form').addEventListener('submit', function(e) {
        // Only index skill-related arrays; leave document inputs intact
        const skillRows = document.querySelectorAll('.skill-row');
        skillRows.forEach((row, index) => {
            const inputs = row.querySelectorAll('input, select');
            inputs.forEach(input => {
                const nm = input.name || '';
                if ((nm.startsWith('skill_') || nm === 'certified[]') && nm.includes('[]')) {
                    input.name = nm.replace('[]', `[${index}]`);
                }
            });
        });

        // Submit a skill_count to signal intent (including zero) so backend can clear when needed
        let hidden = document.querySelector('input[name="skill_count"]');
        if (!hidden) {
            hidden = document.createElement('input');
            hidden.type = 'hidden';
            hidden.name = 'skill_count';
            this.appendChild(hidden);
        }
        hidden.value = String(skillRows.length);
    });

</script>
{% endblock %}